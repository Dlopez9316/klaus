<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconciliation Agent Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        .match-card {
            border-left: 4px solid #0d6efd;
        }
        .confidence-badge {
            font-size: 1rem;
            padding: 0.5rem 1rem;
        }
        .association-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .btn-reconcile {
            font-size: 1.2rem;
            padding: 1rem 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">ü§ñ Reconciliation Agent Dashboard</h1>
        
        <!-- Status Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Learned Associations</h5>
                        <h2 id="associations-count">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Pending Matches</h5>
                        <h2 id="matches-count">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Last Run</h5>
                        <h6 id="last-run">Never</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Schedule</h5>
                        <h6 id="schedule-status">Not Set</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Reconciliation -->
        <div class="card">
            <div class="card-body text-center">
                <h4>Manual Reconciliation</h4>
                <button class="btn btn-primary btn-reconcile" onclick="runReconciliation()">
                    üîç Run Reconciliation Now
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="matches-tab" data-bs-toggle="tab" data-bs-target="#matches" type="button">
                    Pending Matches
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="associations-tab" data-bs-toggle="tab" data-bs-target="#associations" type="button">
                    Teach Associations
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button">
                    Schedule
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Matches Tab -->
            <div class="tab-pane fade show active" id="matches" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div id="matches-list">
                            <p class="text-muted">Run reconciliation to see matches...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Associations Tab -->
            <div class="tab-pane fade" id="associations" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5>Teach New Association</h5>
                        <form id="teach-form">
                            <div class="mb-3">
                                <label class="form-label">Transaction Name (e.g., "HarborGroup PMD")</label>
                                <input type="text" class="form-control" id="transaction-name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Company Name (e.g., "Swiftwater Apartments, LLC")</label>
                                <input type="text" class="form-control" id="company-name" required>
                            </div>
                            <button type="submit" class="btn btn-success">Teach Association</button>
                        </form>

                        <hr>

                        <h5>Learned Associations</h5>
                        <div id="associations-list" class="association-list">
                            <p class="text-muted">No associations yet...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div class="tab-pane fade" id="schedule" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5>Schedule Automatic Reconciliation</h5>
                        <form id="schedule-form">
                            <div class="mb-3">
                                <label class="form-label">Frequency</label>
                                <select class="form-select" id="frequency">
                                    <option value="none">Disabled</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Time (24-hour format)</label>
                                <input type="time" class="form-control" id="schedule-time" value="09:00">
                            </div>
                            <button type="submit" class="btn btn-primary">Save Schedule</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load initial data
        loadAssociations();
        loadSchedule();

        // Teach form
        document.getElementById('teach-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const transactionName = document.getElementById('transaction-name').value;
            const companyName = document.getElementById('company-name').value;

            const response = await fetch('/teach', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    transaction_name: transactionName,
                    company_name: companyName
                })
            });

            const result = await response.json();
            alert(result.message);
            
            // Clear form and reload
            document.getElementById('teach-form').reset();
            loadAssociations();
        });

        // Schedule form
        document.getElementById('schedule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const frequency = document.getElementById('frequency').value;
            const time = document.getElementById('schedule-time').value;

            const response = await fetch('/schedule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({frequency, time})
            });

            const result = await response.json();
            alert(result.message);
            loadSchedule();
        });

        // Run reconciliation
        async function runReconciliation() {
            document.querySelector('.btn-reconcile').disabled = true;
            document.querySelector('.btn-reconcile').innerHTML = '‚è≥ Running...';

            const response = await fetch('/reconcile?auto_approve_threshold=60');
            const result = await response.json();

            document.querySelector('.btn-reconcile').disabled = false;
            document.querySelector('.btn-reconcile').innerHTML = 'üîç Run Reconciliation Now';

            displayMatches(result.matches);
            document.getElementById('matches-count').innerText = result.matches_found;
            document.getElementById('last-run').innerText = new Date().toLocaleString();
        }

        // Display matches
        function displayMatches(matches) {
            const container = document.getElementById('matches-list');
            
            if (matches.length === 0) {
                container.innerHTML = '<p class="text-muted">No matches found.</p>';
                return;
            }

            container.innerHTML = matches.map((match, idx) => `
                <div class="card match-card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>Transaction: $${match.transaction_amount.toFixed(2)}</h6>
                                <small class="text-muted">${match.transaction_description.substring(0, 100)}...</small>
                            </div>
                            <span class="badge confidence-badge bg-${match.confidence >= 80 ? 'success' : match.confidence >= 60 ? 'warning' : 'danger'}">
                                ${match.confidence}% confidence
                            </span>
                        </div>
                        <hr>
                        <div>
                            <strong>Invoice ${match.invoice_number}</strong> - ${match.company_name}<br>
                            <small>Amount: $${match.invoice_amount.toFixed(2)} | Expected: $${match.expected_amount.toFixed(2)}</small>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success btn-sm" onclick="approveMatch(${idx}, '${match.invoice_id}', '${match.transaction_date}', '${encodeURIComponent(match.transaction_description)}', '${encodeURIComponent(match.company_name)}')">
                                ‚úì Approve
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="teachFromMatch('${encodeURIComponent(match.transaction_description)}', '${encodeURIComponent(match.company_name)}')">
                                üìö Teach & Approve
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Approve match
        async function approveMatch(idx, invoiceId, transactionDate, transactionDesc, companyName) {
            const response = await fetch('/approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    approvals: [{
                        invoice_id: invoiceId,
                        transaction_date: transactionDate,
                        transaction_description: decodeURIComponent(transactionDesc),
                        company_name: decodeURIComponent(companyName)
                    }]
                })
            });

            const result = await response.json();
            alert(result.status === 'success' ? '‚úì Match approved!' : 'Failed: ' + JSON.stringify(result.failed_invoices));
            runReconciliation();
        }

        // Teach from match
        async function teachFromMatch(transactionDesc, companyName) {
            // Extract company name from transaction
            const cleanDesc = decodeURIComponent(transactionDesc).split('ORIG CO NAME:')[1]?.split(' ORIG ID:')[0] || decodeURIComponent(transactionDesc).substring(0, 50);
            
            if (confirm(`Teach association:\n"${cleanDesc}" ‚Üí "${decodeURIComponent(companyName)}"`)) {
                await fetch('/teach', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        transaction_name: cleanDesc,
                        company_name: decodeURIComponent(companyName)
                    })
                });
                alert('‚úì Association learned!');
                loadAssociations();
            }
        }

        // Load associations
        async function loadAssociations() {
            const response = await fetch('/associations');
            const result = await response.json();
            
            document.getElementById('associations-count').innerText = result.count;
            
            const container = document.getElementById('associations-list');
            if (result.count === 0) {
                container.innerHTML = '<p class="text-muted">No associations yet...</p>';
                return;
            }

            container.innerHTML = Object.entries(result.associations).map(([trans, company]) => `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div>
                        <strong>${trans}</strong> ‚Üí ${company}
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteAssociation('${trans}')">Delete</button>
                </div>
            `).join('');
        }

        // Delete association
        async function deleteAssociation(transactionName) {
            if (confirm('Delete this association?')) {
                await fetch('/associations/' + encodeURIComponent(transactionName), {method: 'DELETE'});
                loadAssociations();
            }
        }

        // Load schedule
        async function loadSchedule() {
            const response = await fetch('/schedule');
            const result = await response.json();
            document.getElementById('schedule-status').innerText = result.frequency || 'Not Set';
        }
    </script>
</body>
</html>