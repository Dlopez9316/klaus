<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconciliation Agent Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-elevated: rgba(255, 255, 255, 0.9);
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --text-tertiary: #a1a1a6;
            --accent-blue: #007aff;
            --accent-blue-light: rgba(0, 122, 255, 0.1);
            --accent-green: #34c759;
            --accent-green-light: rgba(52, 199, 89, 0.1);
            --accent-orange: #ff9500;
            --accent-orange-light: rgba(255, 149, 0, 0.1);
            --accent-red: #ff3b30;
            --accent-red-light: rgba(255, 59, 48, 0.1);
            --accent-purple: #af52de;
            --accent-purple-light: rgba(175, 82, 222, 0.1);
            --accent-indigo: #5856d6;
            --accent-indigo-light: rgba(88, 86, 214, 0.1);
            --accent-teal: #5ac8fa;
            --accent-teal-light: rgba(90, 200, 250, 0.1);
            --border-light: rgba(0, 0, 0, 0.06);
            --border-medium: rgba(0, 0, 0, 0.1);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.04);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 18px;
            --radius-xl: 22px;
            --font-system: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-system);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.47059;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            padding: 24px;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at 30% 10%, rgba(0, 122, 255, 0.04) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 90%, rgba(88, 86, 214, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        .header {
            background: var(--bg-elevated);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: 20px 28px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            animation: fadeDown 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(-10px);
        }
        @keyframes fadeDown { to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .logo-icon {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-indigo) 100%);
            border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }
        .logo-icon i { font-size: 22px; color: white; }
        .header-title h1 { font-size: 22px; font-weight: 600; letter-spacing: -0.03em; margin-bottom: 2px; }
        .header-title p { font-size: 13px; color: var(--text-secondary); }
        .header-actions { display: flex; gap: 12px; }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 12px 20px; border-radius: var(--radius-md);
            font-size: 14px; font-weight: 500; cursor: pointer;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            border: none; font-family: inherit;
        }
        .btn-secondary {
            background: var(--bg-secondary); color: var(--text-primary);
            border: 1px solid var(--border-medium); box-shadow: var(--shadow-sm);
        }
        .btn-secondary:hover { background: var(--bg-primary); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-primary {
            background: var(--accent-blue); color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }
        .btn-primary:hover { background: #0066d6; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-success { background: var(--accent-green); color: white; box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3); }
        .btn-success:hover { background: #2db24d; transform: translateY(-1px); }
        .btn-danger { background: var(--accent-red); color: white; box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3); }
        .btn-danger:hover { background: #e6342b; transform: translateY(-1px); }
        .btn-sm { padding: 8px 14px; font-size: 12px; border-radius: var(--radius-sm); }
        .btn i { font-size: 16px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            position: relative; overflow: hidden;
            animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0; transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.15s; }
        .stat-card:nth-child(3) { animation-delay: 0.2s; }
        .stat-card:nth-child(4) { animation-delay: 0.25s; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.blue::before { background: var(--accent-blue); }
        .stat-card.teal::before { background: var(--accent-teal); }
        .stat-card.purple::before { background: var(--accent-purple); }
        .stat-card.green::before { background: var(--accent-green); }
        .stat-icon {
            width: 40px; height: 40px; border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center; margin-bottom: 16px;
        }
        .stat-card.blue .stat-icon { background: var(--accent-blue-light); color: var(--accent-blue); }
        .stat-card.teal .stat-icon { background: var(--accent-teal-light); color: var(--accent-teal); }
        .stat-card.purple .stat-icon { background: var(--accent-purple-light); color: var(--accent-purple); }
        .stat-card.green .stat-icon { background: var(--accent-green-light); color: var(--accent-green); }
        .stat-icon i { font-size: 18px; }
        .stat-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 6px; }
        .stat-value { font-size: 32px; font-weight: 600; letter-spacing: -0.04em; line-height: 1; }
        .stat-value-sm { font-size: 18px; font-weight: 500; }

        /* Tabs */
        .tabs-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s forwards;
            opacity: 0; transform: translateY(10px);
        }
        .tabs-header {
            display: flex; gap: 4px; padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            overflow-x: auto; flex-wrap: wrap;
        }
        .tab-btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 16px; border-radius: 999px;
            font-size: 13px; font-weight: 500;
            background: transparent; border: 1px solid var(--border-light);
            color: var(--text-secondary); cursor: pointer;
            transition: all 0.2s ease; white-space: nowrap;
        }
        .tab-btn:hover { background: var(--bg-primary); color: var(--text-primary); }
        .tab-btn.active {
            background: var(--accent-blue-light);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }
        .tab-btn i { font-size: 14px; }
        .tabs-content { padding: 24px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeUp 0.3s ease; }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            margin-bottom: 12px;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .card-body { padding: 20px; }

        /* Match Card */
        .match-card {
            border-left: 4px solid var(--accent-blue);
            background: var(--bg-secondary);
        }
        .match-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .match-amount { font-size: 20px; font-weight: 600; letter-spacing: -0.02em; }
        .match-dates { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .date-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 8px;
            font-size: 12px; font-weight: 500;
            background: var(--accent-blue-light); color: var(--accent-blue);
        }
        .match-description {
            font-size: 13px; color: var(--text-secondary);
            margin-bottom: 12px; cursor: help;
            position: relative;
        }
        .tooltip-content {
            visibility: hidden; opacity: 0;
            position: absolute; bottom: 125%; left: 0;
            width: 400px; max-width: 90vw;
            background: var(--text-primary); color: white;
            padding: 12px 16px; border-radius: var(--radius-sm);
            font-size: 12px; white-space: pre-wrap;
            box-shadow: var(--shadow-lg);
            transition: opacity 0.2s ease;
            z-index: 100;
        }
        .match-description:hover .tooltip-content { visibility: visible; opacity: 1; }
        .match-divider { height: 1px; background: var(--border-light); margin: 16px 0; }
        .match-invoice { margin-bottom: 16px; }
        .match-invoice-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .match-invoice-details { font-size: 12px; color: var(--text-secondary); }
        .match-actions { display: flex; gap: 8px; }
        .confidence-badge {
            padding: 6px 12px; border-radius: 999px;
            font-size: 12px; font-weight: 600;
        }
        .confidence-badge.high { background: var(--accent-green-light); color: var(--accent-green); }
        .confidence-badge.medium { background: var(--accent-orange-light); color: var(--accent-orange); }
        .confidence-badge.low { background: var(--accent-red-light); color: var(--accent-red); }

        /* Suggestion Card */
        .suggestion-card { border-left: 4px solid var(--accent-orange); }

        /* Validation Card */
        .validation-card { margin-bottom: 10px; }
        .validation-card.balanced { border-left: 4px solid var(--accent-green); }
        .validation-card.short { border-left: 4px solid var(--accent-orange); }
        .validation-card.over { border-left: 4px solid var(--accent-blue); }

        /* Section Header */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .section-title { font-size: 17px; font-weight: 600; }
        .section-desc { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .form-input, .form-select {
            width: 100%; padding: 12px 16px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            font-size: 14px; font-family: inherit;
            background: var(--bg-secondary);
            transition: all 0.2s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--accent-blue-light);
        }
        .form-hint { font-size: 12px; color: var(--text-secondary); margin-top: 6px; }

        /* Grid Layout */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

        /* Status Cards */
        .status-card {
            padding: 16px; border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }
        .status-card.success { background: var(--accent-green-light); border-color: rgba(52, 199, 89, 0.2); }
        .status-card.info { background: var(--accent-blue-light); border-color: rgba(0, 122, 255, 0.2); }
        .status-card h4 { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .status-card p { font-size: 13px; color: var(--text-primary); margin: 0; }

        /* Empty State */
        .empty-state {
            text-align: center; padding: 48px 24px;
            background: var(--bg-primary); border-radius: var(--radius-md);
            color: var(--text-secondary);
        }
        .empty-state i { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }
        .empty-state p { font-size: 14px; }

        /* Alert */
        .alert {
            padding: 16px 20px; border-radius: var(--radius-md);
            font-size: 13px; margin-bottom: 16px;
        }
        .alert-info { background: var(--accent-blue-light); color: var(--accent-blue); }
        .alert-success { background: var(--accent-green-light); color: var(--accent-green); }
        .alert-danger { background: var(--accent-red-light); color: var(--accent-red); }
        .alert-warning { background: var(--accent-orange-light); color: var(--accent-orange); }

        /* Spinner */
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid var(--accent-blue-light);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* List Row */
        .list-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border-light);
        }
        .list-row:last-child { border-bottom: none; }

        /* Summary Grid */
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .summary-card {
            text-align: center; padding: 20px;
            border-radius: var(--radius-md); border: 1px solid var(--border-light);
        }
        .summary-card i { font-size: 28px; margin-bottom: 8px; }
        .summary-card .value { font-size: 28px; font-weight: 600; }
        .summary-card .label { font-size: 12px; color: var(--text-secondary); }
        .summary-card.green { background: var(--accent-green-light); }
        .summary-card.green i { color: var(--accent-green); }
        .summary-card.orange { background: var(--accent-orange-light); }
        .summary-card.orange i { color: var(--accent-orange); }
        .summary-card.blue { background: var(--accent-blue-light); }
        .summary-card.blue i { color: var(--accent-blue); }

        /* Badge */
        .badge {
            display: inline-flex; align-items: center;
            padding: 4px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 600;
        }
        .badge-success { background: var(--accent-green); color: white; }
        .badge-warning { background: var(--accent-orange); color: white; }
        .badge-info { background: var(--accent-blue); color: white; }

        /* Responsive */
        @media (max-width: 1200px) { .stats-grid, .summary-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 900px) {
            .header { flex-direction: column; gap: 16px; text-align: center; }
            .header-left { flex-direction: column; }
            .header-actions { width: 100%; justify-content: center; }
            .grid-2 { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            .stats-grid, .summary-grid { grid-template-columns: 1fr; }
            .tabs-header { gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo-icon"><i class="bi bi-diagram-3"></i></div>
                <div class="header-title">
                    <h1>Reconciliation Agent</h1>
                    <p>Faster closeouts - Cleaner books - Fewer headaches</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="/klaus" class="btn btn-secondary">
                    <i class="bi bi-robot"></i> Klaus Dashboard
                </a>
                <button class="btn btn-primary" onclick="runReconciliation()" id="btn-reconcile">
                    <i class="bi bi-lightning-charge-fill"></i> Run Reconciliation
                </button>
            </div>
        </header>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-icon"><i class="bi bi-link-45deg"></i></div>
                <div class="stat-label">Learned Associations</div>
                <div class="stat-value" id="associations-count">0</div>
            </div>
            <div class="stat-card teal">
                <div class="stat-icon"><i class="bi bi-journal-check"></i></div>
                <div class="stat-label">Pending Matches</div>
                <div class="stat-value" id="matches-count">0</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-icon"><i class="bi bi-clock-history"></i></div>
                <div class="stat-label">Last Run</div>
                <div class="stat-value stat-value-sm" id="last-run">Never</div>
            </div>
            <div class="stat-card green">
                <div class="stat-icon"><i class="bi bi-calendar2-check"></i></div>
                <div class="stat-label">Schedule</div>
                <div class="stat-value stat-value-sm" id="schedule-status">Not Set</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="matches"><i class="bi bi-list-check"></i> Pending Matches</button>
                <button class="tab-btn" data-tab="validation"><i class="bi bi-shield-check"></i> Payment Validation</button>
                <button class="tab-btn" data-tab="suggestions"><i class="bi bi-stars"></i> AI Suggestions</button>
                <button class="tab-btn" data-tab="associations"><i class="bi bi-person-gear"></i> Teach Associations</button>
                <button class="tab-btn" data-tab="notifications"><i class="bi bi-bell"></i> Notifications</button>
                <button class="tab-btn" data-tab="schedule"><i class="bi bi-calendar-week"></i> Schedule</button>
            </div>
            <div class="tabs-content">
                <!-- Matches Tab -->
                <div class="tab-pane active" id="tab-matches">
                    <div id="matches-list">
                        <div class="empty-state">
                            <i class="bi bi-search"></i>
                            <p>Run reconciliation to see matches...</p>
                        </div>
                    </div>
                </div>

                <!-- Validation Tab -->
                <div class="tab-pane" id="tab-validation">
                    <div class="section-header">
                        <div>
                            <div class="section-title">Company Payment History Validation</div>
                            <div class="section-desc">Verify that payments match paid invoices for each company</div>
                        </div>
                        <button class="btn btn-primary" onclick="loadValidationReport()">
                            <i class="bi bi-shield-check"></i> Run Validation Report
                        </button>
                    </div>
                    <div class="summary-grid" id="validation-summary" style="display: none;">
                        <div class="summary-card green">
                            <i class="bi bi-check-circle"></i>
                            <div class="value" id="balanced-count">0</div>
                            <div class="label">Balanced</div>
                        </div>
                        <div class="summary-card orange">
                            <i class="bi bi-exclamation-triangle"></i>
                            <div class="value" id="short-count">0</div>
                            <div class="label">Missing Payments</div>
                        </div>
                        <div class="summary-card blue">
                            <i class="bi bi-info-circle"></i>
                            <div class="value" id="over-count">0</div>
                            <div class="label">Extra Payments</div>
                        </div>
                        <div class="summary-card blue">
                            <i class="bi bi-building"></i>
                            <div class="value" id="total-companies">0</div>
                            <div class="label">Total Companies</div>
                        </div>
                    </div>
                    <div id="validation-list">
                        <div class="empty-state">
                            <i class="bi bi-shield"></i>
                            <p>Click "Run Validation Report" to check payment history...</p>
                        </div>
                    </div>
                </div>

                <!-- Suggestions Tab -->
                <div class="tab-pane" id="tab-suggestions">
                    <div class="section-header">
                        <div>
                            <div class="section-title">AI-Suggested Associations</div>
                            <div class="section-desc">The AI analyzes your paid invoices and bank transactions to suggest associations</div>
                        </div>
                        <button class="btn btn-primary" onclick="loadSuggestions()">
                            <i class="bi bi-cpu"></i> Analyze History
                        </button>
                    </div>
                    <div id="suggestions-list">
                        <div class="empty-state">
                            <i class="bi bi-magic"></i>
                            <p>Click the button above to generate suggestions...</p>
                        </div>
                    </div>
                </div>

                <!-- Associations Tab -->
                <div class="tab-pane" id="tab-associations">
                    <div class="grid-2">
                        <div>
                            <div class="section-title" style="margin-bottom: 20px;">Teach New Association</div>
                            <form id="teach-form">
                                <div class="form-group">
                                    <label class="form-label">Transaction Keyword</label>
                                    <input type="text" class="form-input" id="transaction-name" required placeholder="e.g., HarborGroup">
                                    <div class="form-hint">Enter a keyword that appears in transaction descriptions</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Company Name</label>
                                    <input type="text" class="form-input" id="company-name" required placeholder="e.g., HG Sealofts, LLC">
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check2-circle"></i> Teach Association
                                </button>
                            </form>
                        </div>
                        <div>
                            <div class="section-title" style="margin-bottom: 20px;">Learned Associations</div>
                            <div id="associations-list">
                                <div class="empty-state"><p>No associations yet...</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Tab -->
                <div class="tab-pane" id="tab-notifications">
                    <div class="section-title" style="margin-bottom: 8px;">Notification Settings</div>
                    <div class="section-desc" style="margin-bottom: 20px;">Get reports via email or WhatsApp when reconciliation runs</div>
                    <div class="grid-2" style="margin-bottom: 24px;">
                        <div class="status-card success">
                            <h4>Email Status</h4>
                            <p id="email-status">Checking...</p>
                        </div>
                        <div class="status-card info">
                            <h4>WhatsApp Status</h4>
                            <p id="whatsapp-status">Checking...</p>
                        </div>
                    </div>
                    <div class="section-title" style="margin-bottom: 12px;">Send Test Notification</div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="sendTestNotification('email')">
                            <i class="bi bi-envelope"></i> Test Email
                        </button>
                        <button class="btn btn-success" onclick="sendTestNotification('whatsapp')">
                            <i class="bi bi-whatsapp"></i> Test WhatsApp
                        </button>
                        <button class="btn btn-secondary" onclick="sendTestNotification('both')">
                            <i class="bi bi-bell"></i> Test Both
                        </button>
                    </div>
                    <div id="notification-result"></div>
                    <div class="alert alert-info">
                        <strong>Setup Instructions:</strong><br>
                        <strong>Email:</strong> Configure SMTP settings in your .env file<br>
                        <strong>WhatsApp:</strong> Set up Twilio account and configure credentials in .env
                    </div>
                </div>

                <!-- Schedule Tab -->
                <div class="tab-pane" id="tab-schedule">
                    <div class="section-title" style="margin-bottom: 8px;">Schedule Automatic Reconciliation</div>
                    <div class="section-desc" style="margin-bottom: 20px;">Automated reconciliation will send notifications to your configured channels</div>
                    <form id="schedule-form" style="max-width: 500px;">
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Frequency</label>
                                <select class="form-select" id="frequency">
                                    <option value="none">Disabled</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly (Monday)</option>
                                    <option value="monthly">Monthly (1st)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time</label>
                                <input type="time" class="form-input" id="schedule-time" value="09:00">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Schedule
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // Init
        loadAssociations();
        loadSchedule();
        checkNotificationStatus();

        document.getElementById('teach-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const response = await fetch('/teach', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    transaction_name: document.getElementById('transaction-name').value,
                    company_name: document.getElementById('company-name').value
                })
            });
            const result = await response.json();
            alert(result.message);
            document.getElementById('teach-form').reset();
            loadAssociations();
        });

        document.getElementById('schedule-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const response = await fetch('/schedule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    frequency: document.getElementById('frequency').value,
                    time: document.getElementById('schedule-time').value
                })
            });
            const result = await response.json();
            alert(result.message);
            loadSchedule();
        });

        async function runReconciliation() {
            const btn = document.getElementById('btn-reconcile');
            const container = document.getElementById('matches-list');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Running...';
            container.innerHTML = '<div class="empty-state"><span class="spinner"></span><p>Running reconciliation...</p></div>';

            try {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 90);
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];

                const response = await fetch(`/reconcile?start_date=${startDateStr}&end_date=${endDateStr}&auto_approve_threshold=50`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }

                const result = await response.json();
                if (result.status === 'success') {
                    displayMatches(result.matches);
                    document.getElementById('matches-count').innerText = result.matches_found || 0;
                    document.getElementById('last-run').innerText = new Date().toLocaleTimeString();

                    if (result.matches_found === 0) {
                        container.innerHTML = `<div class="alert alert-info">Reconciliation complete. Analyzed ${result.transactions_analyzed || 0} transactions and ${result.invoices_analyzed || 0} invoices. No matches found.</div>`;
                    }
                }
            } catch(e) {
                container.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-lightning-charge-fill"></i> Run Reconciliation';
            }
        }

        function displayMatches(matches) {
            const container = document.getElementById('matches-list');
            if (!matches || matches.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>No matches found.</p></div>';
                return;
            }

            let html = '';
            matches.forEach((m, i) => {
                const badgeClass = m.confidence >= 80 ? 'high' : (m.confidence >= 70 ? 'medium' : 'low');
                const transDate = m.transaction_date ? new Date(m.transaction_date).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'}) : 'N/A';
                const invDate = m.invoice_date ? new Date(m.invoice_date).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'}) : 'N/A';
                const fullDesc = m.transaction_description || '';
                const truncDesc = fullDesc.substring(0, 80) + (fullDesc.length > 80 ? '...' : '');
                const escapedDesc = fullDesc.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const escapedCompany = (m.company_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                html += `
                <div class="card match-card" id="match-${i}">
                    <div class="card-body">
                        <div class="match-header">
                            <div class="match-amount">$${m.transaction_amount.toFixed(2)}</div>
                            <span class="confidence-badge ${badgeClass}">${m.confidence}%</span>
                        </div>
                        <div class="match-dates">
                            <span class="date-badge"><i class="bi bi-bank"></i> Bank: ${transDate}</span>
                            <span class="date-badge"><i class="bi bi-receipt"></i> Invoice: ${invDate}</span>
                        </div>
                        <div class="match-description">
                            ${truncDesc}
                            <div class="tooltip-content">${fullDesc.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                        </div>
                        <div class="match-divider"></div>
                        <div class="match-invoice">
                            <div class="match-invoice-title">Invoice ${m.invoice_number} - ${m.company_name}</div>
                            <div class="match-invoice-details">Amount: $${m.invoice_amount.toFixed(2)} | Expected: $${m.expected_amount.toFixed(2)}</div>
                        </div>
                        <div class="match-actions">
                            <button class="btn btn-sm btn-success" onclick="approveMatch('${m.invoice_id}', '${m.transaction_date || ''}', '${escapedDesc}', '${escapedCompany}', this)">
                                <i class="bi bi-check-circle"></i> Approve
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="denyMatch('${m.invoice_id}', '${escapedDesc}', this)">
                                <i class="bi bi-x-circle"></i> Deny
                            </button>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        async function approveMatch(invoiceId, transactionDate, transactionDesc, companyName, btn) {
            const card = btn.closest('.match-card');
            const buttons = card.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);
            btn.innerHTML = '<span class="spinner"></span>';

            try {
                const response = await fetch('/approve-bulk', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        approvals: [{ invoice_id: invoiceId, transaction_date: transactionDate, transaction_description: transactionDesc, company_name: companyName }]
                    })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    card.style.transition = 'all 0.3s ease';
                    card.style.background = 'var(--accent-green-light)';
                    card.style.borderLeftColor = 'var(--accent-green)';
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Approved!';
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(50px)';
                        setTimeout(() => card.remove(), 300);
                    }, 500);
                    updateMatchCount(-1);
                } else {
                    btn.innerHTML = '<i class="bi bi-x-circle"></i> Failed';
                    buttons.forEach(b => b.disabled = false);
                }
            } catch(e) {
                btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
                buttons.forEach(b => b.disabled = false);
            }
        }

        async function denyMatch(invoiceId, transactionDesc, btn) {
            const card = btn.closest('.match-card');
            const buttons = card.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);
            btn.innerHTML = '<span class="spinner"></span>';

            try {
                const response = await fetch('/deny', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ invoice_id: invoiceId, transaction_description: transactionDesc })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    card.style.transition = 'all 0.3s ease';
                    card.style.background = 'var(--accent-red-light)';
                    card.style.borderLeftColor = 'var(--accent-red)';
                    btn.innerHTML = '<i class="bi bi-x-circle"></i> Denied!';
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(-50px)';
                        setTimeout(() => card.remove(), 300);
                    }, 500);
                    updateMatchCount(-1);
                } else {
                    btn.innerHTML = '<i class="bi bi-x-circle"></i> Failed';
                    buttons.forEach(b => b.disabled = false);
                }
            } catch(e) {
                btn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
                buttons.forEach(b => b.disabled = false);
            }
        }

        function updateMatchCount(delta) {
            const el = document.getElementById('matches-count');
            el.innerText = Math.max(0, (parseInt(el.innerText) || 0) + delta);
        }

        async function loadSuggestions() {
            const container = document.getElementById('suggestions-list');
            container.innerHTML = '<div class="empty-state"><span class="spinner"></span><p>Analyzing historical data...</p></div>';

            try {
                const response = await fetch('/suggest-associations?days=730');
                const result = await response.json();

                if (result.suggestions_count === 0) {
                    container.innerHTML = `<div class="alert alert-info">No suggestions found. Analyzed ${result.analyzed_paid_invoices} paid invoices.</div>`;
                    return;
                }

                let html = `<div class="alert alert-success">Found ${result.suggestions_count} suggestions from ${result.analyzed_paid_invoices} paid invoices!</div>`;
                result.suggestions.forEach(s => {
                    const badgeClass = s.confidence >= 70 ? 'high' : (s.confidence >= 50 ? 'medium' : 'low');
                    html += `
                    <div class="card suggestion-card">
                        <div class="card-body">
                            <div class="match-header">
                                <div>
                                    <strong>${s.transaction_name}</strong> → ${s.company_name}<br>
                                    <small style="color: var(--text-secondary);">Example: Invoice ${s.example_invoice} ($${s.example_amount.toFixed(2)})</small>
                                </div>
                                <span class="confidence-badge ${badgeClass}">${s.confidence}%</span>
                            </div>
                            <div style="margin-top: 12px;">
                                <button class="btn btn-sm btn-success" onclick="approveSuggestion('${s.transaction_name.replace(/'/g, '')}', '${s.company_name.replace(/'/g, '')}')">
                                    <i class="bi bi-check"></i> Approve & Learn
                                </button>
                            </div>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } catch(e) {
                container.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
            }
        }

        async function approveSuggestion(transactionName, companyName) {
            const response = await fetch('/teach', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ transaction_name: transactionName, company_name: companyName })
            });
            const result = await response.json();
            alert(result.message);
            loadAssociations();
            loadSuggestions();
        }

        async function loadValidationReport() {
            const container = document.getElementById('validation-list');
            const summaryDiv = document.getElementById('validation-summary');
            container.innerHTML = '<div class="empty-state"><span class="spinner"></span><p>Validating payment history...</p></div>';

            try {
                const response = await fetch('/validation-report?days=730');
                const result = await response.json();

                document.getElementById('balanced-count').innerText = result.summary.balanced;
                document.getElementById('short-count').innerText = result.summary.short;
                document.getElementById('over-count').innerText = result.summary.over;
                document.getElementById('total-companies').innerText = result.summary.total_companies;
                summaryDiv.style.display = 'grid';

                let html = '';
                if (result.balanced_companies.length > 0) {
                    html += `<div class="section-title" style="color: var(--accent-green); margin: 20px 0 12px;"><i class="bi bi-check-circle"></i> Balanced Companies (${result.balanced_companies.length})</div>`;
                    result.balanced_companies.forEach(c => {
                        html += `<div class="card validation-card balanced"><div class="card-body">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div><strong>${c.company_name}</strong><br><small style="color: var(--text-secondary);">${c.message}</small><br>
                                <small style="color: var(--text-secondary);">Paid: $${c.paid_invoices_total.toFixed(2)} | Payments: $${c.payments_total.toFixed(2)}</small></div>
                                <span class="badge badge-success">OK</span>
                            </div></div></div>`;
                    });
                }
                if (result.short_companies.length > 0) {
                    html += `<div class="section-title" style="color: var(--accent-orange); margin: 20px 0 12px;"><i class="bi bi-exclamation-triangle"></i> Missing Payments (${result.short_companies.length})</div>`;
                    result.short_companies.forEach(c => {
                        html += `<div class="card validation-card short"><div class="card-body">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div><strong>${c.company_name}</strong><br><small style="color: var(--text-secondary);">${c.message}</small><br>
                                <small style="color: var(--text-secondary);">Paid: $${c.paid_invoices_total.toFixed(2)} | Found: $${c.payments_total.toFixed(2)}</small></div>
                                <span class="badge badge-warning">SHORT</span>
                            </div></div></div>`;
                    });
                }
                if (result.over_companies.length > 0) {
                    html += `<div class="section-title" style="color: var(--accent-blue); margin: 20px 0 12px;"><i class="bi bi-info-circle"></i> Extra Payments (${result.over_companies.length})</div>`;
                    result.over_companies.forEach(c => {
                        html += `<div class="card validation-card over"><div class="card-body">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div><strong>${c.company_name}</strong><br><small style="color: var(--text-secondary);">${c.message}</small><br>
                                <small style="color: var(--text-secondary);">Paid: $${c.paid_invoices_total.toFixed(2)} | Found: $${c.payments_total.toFixed(2)}</small></div>
                                <span class="badge badge-info">OVER</span>
                            </div></div></div>`;
                    });
                }
                container.innerHTML = html || '<div class="empty-state"><p>No companies found</p></div>';
            } catch(e) {
                container.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
            }
        }

        async function loadAssociations() {
            const response = await fetch('/associations');
            const result = await response.json();
            document.getElementById('associations-count').innerText = result.count;
            const container = document.getElementById('associations-list');

            if (result.count === 0) {
                container.innerHTML = '<div class="empty-state"><p>No associations yet...</p></div>';
                return;
            }

            let html = '';
            for (const [trans, company] of Object.entries(result.associations)) {
                html += `<div class="list-row">
                    <div><strong>${trans}</strong> → ${company}</div>
                    <button class="btn btn-sm btn-danger" onclick="deleteAssociation('${trans.replace(/'/g, '')}')">Delete</button>
                </div>`;
            }
            container.innerHTML = html;
        }

        async function deleteAssociation(name) {
            if (confirm('Delete this association?')) {
                await fetch('/associations/' + encodeURIComponent(name), {method: 'DELETE'});
                loadAssociations();
            }
        }

        async function loadSchedule() {
            const response = await fetch('/schedule');
            const result = await response.json();
            document.getElementById('schedule-status').innerText = result.frequency || 'Not Set';
            document.getElementById('frequency').value = result.frequency || 'none';
            document.getElementById('schedule-time').value = result.time || '09:00';
        }

        async function checkNotificationStatus() {
            try {
                const response = await fetch('/health');
                const result = await response.json();
                document.getElementById('email-status').innerHTML = result.services.email === 'configured' ?
                    '<span style="color: var(--accent-green);">Configured</span>' :
                    '<span style="color: var(--accent-orange);">Not configured</span>';
                document.getElementById('whatsapp-status').innerHTML = result.services.whatsapp === 'configured' ?
                    '<span style="color: var(--accent-green);">Configured</span>' :
                    '<span style="color: var(--accent-orange);">Not configured</span>';
            } catch(e) {}
        }

        async function sendTestNotification(type) {
            const resultDiv = document.getElementById('notification-result');
            resultDiv.innerHTML = '<div class="alert alert-info"><span class="spinner"></span> Sending test notification...</div>';

            try {
                const response = await fetch('/notification/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        via_email: type === 'email' || type === 'both',
                        via_whatsapp: type === 'whatsapp' || type === 'both'
                    })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    let msg = '<strong>Test Results:</strong><br>';
                    if (result.results?.email?.sent) msg += 'Email sent successfully!<br>';
                    else if (result.results?.email?.error) msg += 'Email failed: ' + result.results.email.error + '<br>';
                    if (result.results?.whatsapp?.sent) msg += 'WhatsApp sent successfully!<br>';
                    else if (result.results?.whatsapp?.error) msg += 'WhatsApp failed: ' + result.results.whatsapp.error + '<br>';
                    resultDiv.innerHTML = '<div class="alert alert-success">' + msg + '</div>';
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger">Test failed</div>';
                }
            } catch(e) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + e.message + '</div>';
            }
        }
    </script>
</body>
</html>
