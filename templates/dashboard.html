<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reconciliation Agent Dashboard</title>

  <!-- Bootstrap core -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1020;
      --card: #121a3a;
      --card-2: #0f1733;
      --text: #e9eefc;              /* main text */
      --text-strong: #f7f9ff;       /* extra bright for contrast */
      --muted: #bfc6e4;
      --primary: #7aa2ff;
      --primary-strong:#5a86ff;
      --warning:#ffd166;
      --success:#66e0a3;
      --danger:#ff6b6b;
      --shadow: 0 10px 30px rgba(10,14,40,.35);
      --radius: 18px;
    }
    *{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;}
    body{
      background: radial-gradient(90rem 60rem at -20% -20%, #18255a 0%, rgba(11,16,32,0) 40%),
                  radial-gradient(80rem 60rem at 120% -10%, #1d2b70 0%, rgba(11,16,32,0) 50%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 18px 18px 48px;
    }
    .app-nav{
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(15,21,48,.65), rgba(15,21,48,.35));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .brand{font-weight: 700; letter-spacing:.3px;}
    .kpi-card{
      background: linear-gradient(180deg, rgba(122,162,255,.10), rgba(18,26,58,.85));
      border: 1px solid rgba(122,162,255,.25);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      height: 100%;
    }
    .kpi-card .icon{
      width: 44px;height: 44px;border-radius: 12px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(122,162,255,.15);color: var(--primary);
      box-shadow: inset 0 0 0 1px rgba(122,162,255,.35);
    }
    .kpi-value{font-size: 2.4rem; font-weight: 700; color: #ffffff;}
    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card-plain{background: var(--card-2);}

    /* Tabs */
    .nav-tabs{
      border: none; gap: .5rem; margin-top: .25rem;
    }
    .nav-tabs .nav-link{
      color: var(--muted);
      border: 1px solid rgba(255,255,255,.08) !important;
      border-radius: 999px !important;
      background: rgba(255,255,255,.02);
      padding: .6rem 1.1rem;
      display: inline-flex; align-items: center; gap: .5rem;
    }
    .nav-tabs .nav-link.active{
      color: var(--text-strong);
      background: linear-gradient(180deg, rgba(122,162,255,.25), rgba(122,162,255,.08));
      border-color: rgba(122,162,255,.35) !important;
      box-shadow: 0 6px 20px rgba(122,162,255,.25);
    }

    /* Buttons */
    .btn-primary{
      background: linear-gradient(180deg, var(--primary), var(--primary-strong));
      border: 1px solid rgba(122,162,255,.65);
      box-shadow: 0 10px 20px rgba(90,134,255,.35);
      border-radius: 14px;
    }
    .btn-reconcile{font-size: 1.05rem; padding:.9rem 1.4rem;}
    .confidence-badge{
      font-size: .95rem;
      padding: .45rem .8rem;
      border-radius: 999px;
    }

    /* List cards */
    .match-card,.suggestion-card{
      border-left: 4px solid var(--primary);
      background: linear-gradient(180deg, rgba(122,162,255,.10), rgba(18,26,58,.85));
      border-radius: 14px;
      border: 1px solid rgba(122,162,255,.25);
      margin-bottom: 14px;
      color: var(--text-strong); /* ensure bright text inside */
    }
    .suggestion-card{border-left-color: var(--warning);}

    .divider{
      height:1px;
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.08), rgba(255,255,255,0));
      margin: .75rem 0 1rem;
    }
    .list-row{
      display:flex;justify-content:space-between;align-items:center;
      padding:.5rem .25rem; border-bottom:1px dashed rgba(255,255,255,.08);
      color: var(--text-strong);
    }
    .list-row:last-child{border-bottom:none;}

    /* >>> UNIVERSAL HIGH-CONTRAST TEXT FIXES <<< */
    /* Make anything â€œmuted/secondary/small/labelâ€ bright and legible */
    .text-muted,
    .text-secondary,
    .text-body-secondary,
    small,
    .form-text,
    .form-label,
    label,
    .card-plain p,
    .card-plain small,
    .match-card small,
    .suggestion-card small {
      color: var(--text-strong) !important;
    }

    /* All text inside cards should be high contrast white */
    .card strong,
    .card-body strong,
    .card-body,
    .card-body div,
    .card h6,
    strong {
      color: var(--text-strong) !important;
    }

    /* Ensure Bootstrap utility text classes have high contrast */
    .text-success,
    .text-warning,
    .text-info,
    .text-danger,
    h6.text-success,
    h6.text-warning,
    h6.text-info {
      filter: brightness(1.5) !important;
    }

    /* Muted containers */
    .muted-box{
      background: rgba(255,255,255,.03);
      border: 1px dashed rgba(255,255,255,.1);
      border-radius: 12px;
      padding: .75rem 1rem;
      color: var(--text-strong) !important;
    }

    /* Inputs: text + placeholder + labels all bright */
    .form-control,
    .form-select{
      color: var(--text-strong);
      background-color: rgba(255,255,255,0.03);
      border-color: rgba(255,255,255,0.18);
    }
    .form-control::placeholder{
      color: rgba(247,249,255,0.85);
      opacity: 1;
    }
    .form-label{ font-weight: 600; color: var(--text-strong) !important; }

    /* Card headings brighter */
    .card-plain h5, .card-plain h6 { color: var(--text-strong); }

    .footer{
      color: var(--muted);
      text-align:center;
      font-size:.85rem;
      margin-top: 28px;
      opacity:.9;
    }
    
    /* Tooltip for transaction descriptions */
    .description-text {
      cursor: help;
      position: relative;
      display: inline-block;
      max-width: 100%;
    }
    
    .description-text .tooltip-content {
      visibility: hidden;
      width: 400px;
      max-width: 90vw;
      background-color: rgba(18, 26, 58, 0.98);
      color: var(--text-strong);
      text-align: left;
      border-radius: 12px;
      padding: 12px 16px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 0;
      margin-left: 0;
      opacity: 0;
      transition: opacity 0.3s;
      border: 1px solid rgba(122, 162, 255, 0.35);
      box-shadow: 0 10px 30px rgba(10, 14, 40, 0.5);
      font-size: 0.9rem;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .description-text .tooltip-content::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 20px;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(18, 26, 58, 0.98) transparent transparent transparent;
    }
    
    .description-text:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }
    
    .date-badge {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(122, 162, 255, 0.15);
      border: 1px solid rgba(122, 162, 255, 0.25);
      border-radius: 8px;
      font-size: 0.85rem;
      margin-right: 8px;
      color: var(--text-strong);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top header -->
    <div class="app-nav d-flex align-items-center justify-content-between p-3 mb-4">
      <div class="d-flex align-items-center gap-3">
        <span class="icon d-inline-flex align-items-center justify-content-center" style="width:42px;height:42px;border-radius:12px;background:rgba(122,162,255,.18);color:var(--primary);box-shadow:inset 0 0 0 1px rgba(122,162,255,.35);">
          <i class="bi bi-diagram-3"></i>
        </span>
        <div>
          <div class="brand h4 mb-0">Reconciliation Agent Dashboard</div>
          <div class="small" style="color: var(--text-strong)">Faster closeouts â€¢ Cleaner books â€¢ Fewer headaches</div>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a href="/klaus" class="btn" style="border-radius: 14px; border: 1px solid rgba(122,162,255,.5); color: var(--primary); padding: .9rem 1.4rem;">
          <i class="bi bi-robot me-1"></i> Klaus Dashboard
        </a>
        <button class="btn btn-primary btn-reconcile" onclick="runReconciliation()">
          <i class="bi bi-lightning-charge me-1"></i> Run Reconciliation Now
        </button>
      </div>
    </div>

    <!-- KPI row -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="kpi-card p-3">
          <div class="d-flex align-items-center justify-content-between">
            <div class="icon"><i class="bi bi-link-45deg"></i></div>
            <span class="badge bg-primary-subtle text-primary">AI Memory</span>
          </div>
          <div class="mt-3">
            <div class="small" style="color: var(--text-strong)">Learned Associations</div>
            <div class="kpi-value" id="associations-count">0</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card p-3">
          <div class="d-flex align-items-center justify-content-between">
            <div class="icon"><i class="bi bi-journal-check"></i></div>
            <span class="badge bg-info-subtle text-info">Queue</span>
          </div>
          <div class="mt-3">
            <div class="small" style="color: var(--text-strong)">Pending Matches</div>
            <div class="kpi-value" id="matches-count">0</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card p-3">
          <div class="d-flex align-items-center justify-content-between">
            <div class="icon"><i class="bi bi-clock-history"></i></div>
            <span class="badge bg-secondary-subtle text-secondary">Runtime</span>
          </div>
          <div class="mt-3">
            <div class="small" style="color: var(--text-strong)">Last Run</div>
            <div class="h5 mb-0" id="last-run">Never</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card p-3">
          <div class="d-flex align-items-center justify-content-between">
            <div class="icon"><i class="bi bi-calendar2-check"></i></div>
            <span class="badge bg-success-subtle text-success">Automation</span>
          </div>
          <div class="mt-3">
            <div class="small" style="color: var(--text-strong)">Schedule</div>
            <div class="h5 mb-0" id="schedule-status">Not Set</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="matches-tab" data-bs-toggle="tab" href="#matches" role="tab" aria-controls="matches" aria-selected="true">
          <i class="bi bi-list-check"></i> Pending Matches
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="validation-tab" data-bs-toggle="tab" href="#validation" role="tab" aria-controls="validation" aria-selected="false">
          <i class="bi bi-shield-check"></i> Payment Validation
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="suggestions-tab" data-bs-toggle="tab" href="#suggestions" role="tab" aria-controls="suggestions" aria-selected="false">
          <i class="bi bi-stars"></i> AI Suggestions
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="associations-tab" data-bs-toggle="tab" href="#associations" role="tab" aria-controls="associations" aria-selected="false">
          <i class="bi bi-person-gear"></i> Teach Associations
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="notifications-tab" data-bs-toggle="tab" href="#notifications" role="tab" aria-controls="notifications" aria-selected="false">
          <i class="bi bi-bell"></i> Notifications
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="schedule-tab" data-bs-toggle="tab" href="#schedule" role="tab" aria-controls="schedule" aria-selected="false">
          <i class="bi bi-calendar-week"></i> Schedule
        </a>
      </li>
    </ul>

    <div class="tab-content mt-3" id="myTabContent">
      <!-- Matches -->
      <div class="tab-pane fade show active" id="matches" role="tabpanel" aria-labelledby="matches-tab">
        <div class="card card-plain">
          <div class="card-body">
            <div id="matches-list" class="muted-box">
              <i class="bi bi-info-circle me-2"></i>
              <span class="text-muted">Run reconciliation to see matches...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Validation -->
      <div class="tab-pane fade" id="validation" role="tabpanel" aria-labelledby="validation-tab">
        <div class="card card-plain">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div>
                <h5 class="mb-1">Company Payment History Validation</h5>
                <p class="mb-0" style="color: var(--text-strong)">Verify that payments match paid invoices for each company (automatically run during reconciliation)</p>
              </div>
              <button class="btn btn-primary" onclick="loadValidationReport()">
                <i class="bi bi-shield-check me-1"></i> Run Validation Report
              </button>
            </div>
            <div class="divider"></div>
            
            <!-- Summary Cards -->
            <div class="row g-3 mb-3" id="validation-summary" style="display: none;">
              <div class="col-md-3">
                <div class="card" style="background: rgba(102,224,163,0.1); border-color: rgba(102,224,163,0.3);">
                  <div class="card-body text-center">
                    <i class="bi bi-check-circle" style="font-size: 2rem; color: var(--success);"></i>
                    <div class="kpi-value" id="balanced-count">0</div>
                    <div class="small" style="color: var(--text-strong)">Balanced</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card" style="background: rgba(255,209,102,0.1); border-color: rgba(255,209,102,0.3);">
                  <div class="card-body text-center">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem; color: var(--warning);"></i>
                    <div class="kpi-value" id="short-count">0</div>
                    <div class="small" style="color: var(--text-strong)">Missing Payments</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card" style="background: rgba(122,162,255,0.1); border-color: rgba(122,162,255,0.3);">
                  <div class="card-body text-center">
                    <i class="bi bi-info-circle" style="font-size: 2rem; color: var(--primary);"></i>
                    <div class="kpi-value" id="over-count">0</div>
                    <div class="small" style="color: var(--text-strong)">Extra Payments</div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card" style="background: rgba(122,162,255,0.1); border-color: rgba(122,162,255,0.3);">
                  <div class="card-body text-center">
                    <i class="bi bi-building" style="font-size: 2rem; color: var(--primary);"></i>
                    <div class="kpi-value" id="total-companies">0</div>
                    <div class="small" style="color: var(--text-strong)">Total Companies</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="validation-list" class="muted-box">
              <i class="bi bi-info-circle me-2"></i>
              <span class="text-muted">Click "Run Validation Report" to check payment history...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Suggestions -->
      <div class="tab-pane fade" id="suggestions" role="tabpanel" aria-labelledby="suggestions-tab">
        <div class="card card-plain">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div>
                <h5 class="mb-1">AI-Suggested Associations from Historical Data</h5>
                <p class="mb-0" style="color: var(--text-strong)">The AI analyzes your paid invoices and bank transactions to suggest associations.</p>
              </div>
              <button class="btn btn-primary" onclick="loadSuggestions()">
                <i class="bi bi-cpu me-1"></i> Analyze History & Generate Suggestions
              </button>
            </div>
            <div class="divider"></div>
            <div id="suggestions-list" class="muted-box">
              <i class="bi bi-magic me-2"></i>
              <span class="text-muted">Click the button above to generate suggestions...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Teach Associations -->
      <div class="tab-pane fade" id="associations" role="tabpanel" aria-labelledby="associations-tab">
        <div class="card card-plain">
          <div class="card-body">
            <div class="row g-4">
              <div class="col-md-5">
                <h5 class="mb-3">Teach New Association</h5>
                <form id="teach-form">
                  <div class="mb-3">
                    <label class="form-label">Transaction Keyword</label>
                    <input type="text" class="form-control" id="transaction-name" required placeholder="e.g., HarborGroup">
                    <div class="form-text">Enter a keyword that appears in transaction descriptions</div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Company Name</label>
                    <input type="text" class="form-control" id="company-name" required placeholder="e.g., HG Sealofts, LLC">
                  </div>
                  <button type="submit" class="btn btn-success">
                    <i class="bi bi-check2-circle me-1"></i> Teach Association
                  </button>
                </form>
              </div>
              <div class="col-md-7">
                <h5 class="mb-3">Learned Associations</h5>
                <div id="associations-list" class="muted-box"><span class="text-muted">No associations yet...</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notifications -->
      <div class="tab-pane fade" id="notifications" role="tabpanel" aria-labelledby="notifications-tab">
        <div class="card card-plain">
          <div class="card-body">
            <h5 class="mb-2">Notification Settings</h5>
            <p style="color: var(--text-strong)">Get reports via email or WhatsApp when reconciliation runs.</p>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <div class="p-3 rounded-3" style="background:rgba(102,224,163,.08); border:1px solid rgba(102,224,163,.25)">
                  <h6 class="mb-1">ðŸ“§ Email Status</h6>
                  <p id="email-status" class="mb-0">Checking...</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="p-3 rounded-3" style="background:rgba(122,162,255,.08); border:1px solid rgba(122,162,255,.25)">
                  <h6 class="mb-1">ðŸ’¬ WhatsApp Status</h6>
                  <p id="whatsapp-status" class="mb-0">Checking...</p>
                </div>
              </div>
            </div>
            <div class="divider"></div>
            <h6>Send Test Notification</h6>
            <p style="color: var(--text-strong)">Verify your notification settings are working.</p>
            <div class="btn-group mb-3 flex-wrap" role="group">
              <button class="btn btn-primary" onclick="sendTestNotification('email')">ðŸ“§ Test Email</button>
              <button class="btn btn-success" onclick="sendTestNotification('whatsapp')">ðŸ’¬ Test WhatsApp</button>
              <button class="btn btn-info" onclick="sendTestNotification('both')">ðŸ”” Test Both</button>
            </div>
            <div id="notification-result"></div>
            <div class="divider"></div>
            <div class="alert alert-info mb-0">
              <strong>Setup Instructions:</strong>
              <ul class="mb-0">
                <li><strong>Email:</strong> Configure SMTP settings in your .env file</li>
                <li><strong>WhatsApp:</strong> Set up Twilio account and configure credentials in .env</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Schedule -->
      <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
        <div class="card card-plain">
          <div class="card-body">
            <h5 class="mb-2">Schedule Automatic Reconciliation</h5>
            <p style="color: var(--text-strong)">Automated reconciliation will send notifications to your configured channels.</p>
            <form id="schedule-form" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Frequency</label>
                <select class="form-select" id="frequency">
                  <option value="none">Disabled</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly (Monday)</option>
                  <option value="monthly">Monthly (1st of month)</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Time</label>
                <input type="time" class="form-control" id="schedule-time" value="09:00">
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-save me-1"></i> Save Schedule
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">Built for speed â€¢ Designed for clarity â€¢ Ready for scale</div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Original functionality preserved -->
  <script>
    // INIT
    loadAssociations();
    loadSchedule();
    checkNotificationStatus();

    document.getElementById('teach-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const response = await fetch('/teach', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          transaction_name: document.getElementById('transaction-name').value,
          company_name: document.getElementById('company-name').value
        })
      });
      const result = await response.json();
      alert(result.message);
      document.getElementById('teach-form').reset();
      loadAssociations();
    });

    document.getElementById('schedule-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const response = await fetch('/schedule', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          frequency: document.getElementById('frequency').value,
          time: document.getElementById('schedule-time').value
        })
      });
      const result = await response.json();
      alert(result.message);
      loadSchedule();
    });

    async function runReconciliation() {
      const btn = document.querySelector('.btn-reconcile');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>Running...';
      try {
        // Calculate date range: 90 days back to today
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 90);
        
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];
        
        const response = await fetch(`/reconcile?start_date=${startDateStr}&end_date=${endDateStr}&auto_approve_threshold=50`);
        const result = await response.json();
        displayMatches(result.matches);
        document.getElementById('matches-count').innerText = result.matches_found;
        document.getElementById('last-run').innerText = new Date().toLocaleString();
      } catch(e) {
        alert('Error: ' + e.message);
      }
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-lightning-charge me-1"></i> Run Reconciliation Now';
    }

    async function loadSuggestions() {
      const container = document.getElementById('suggestions-list');
      container.innerHTML = '<div class="text-muted"><span class="spinner-border spinner-border-sm me-2"></span>Analyzing historical data... This may take a minute...</div>';
      try {
        const response = await fetch('/suggest-associations?days=730');
        const result = await response.json();

        if (result.suggestions_count === 0) {
          container.innerHTML = '<p class="text-muted">No suggestions found. Analyzed ' + result.analyzed_paid_invoices + ' paid invoices and ' + result.analyzed_transactions + ' transactions.</p>';
          return;
        }

        let html = '<p class="text-success">Found ' + result.suggestions_count + ' suggestions from ' + result.analyzed_paid_invoices + ' paid invoices!</p>';
        for (let s of result.suggestions) {
          const badgeColor = s.confidence >= 70 ? 'success' : (s.confidence >= 50 ? 'warning' : 'secondary');
          html += '<div class="card suggestion-card"><div class="card-body">';
          html += '<div class="d-flex justify-content-between"><div>';
          html += '<strong>' + s.transaction_name + '</strong> â†’ ' + s.company_name;
          html += '<br><small class="text-muted">Example: Invoice ' + s.example_invoice + ' ($' + s.example_amount.toFixed(2) + ')</small>';
          html += '</div><span class="badge confidence-badge bg-' + badgeColor + '">' + s.confidence + '%</span></div>';
          html += '<div class="mt-3">';
          html += '<button class="btn btn-success btn-sm" onclick="approveSuggestion(\'' + s.transaction_name.replace(/'/g, '') + '\', \'' + s.company_name.replace(/'/g, '') + '\')">âœ“ Approve & Learn</button>';
          html += '</div></div></div>';
        }
        container.innerHTML = html;
      } catch(e) {
        container.innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
      }
    }

    async function approveSuggestion(transactionName, companyName) {
      const response = await fetch('/teach', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ transaction_name: transactionName, company_name: companyName })
      });
      const result = await response.json();
      alert(result.message);
      loadAssociations();
      loadSuggestions();
    }

    function displayMatches(matches) {
      const container = document.getElementById('matches-list');
      if (!matches || matches.length === 0) {
        container.innerHTML = '<div class="muted-box"><span class="text-muted">No matches found.</span></div>';
        return;
      }
      let html = '';
      for(let i = 0; i < matches.length; i++) {
        const m = matches[i];
        const badgeColor = m.confidence >= 80 ? 'success' : (m.confidence >= 70 ? 'warning' : 'danger');
        
        // Format dates
        const transDate = m.transaction_date ? new Date(m.transaction_date).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'}) : 'N/A';
        const invDate = m.invoice_date ? new Date(m.invoice_date).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'}) : 'N/A';
        
        // Truncate description for display
        const fullDescription = m.transaction_description || '';
        const truncatedDescription = fullDescription.substring(0, 100) + (fullDescription.length > 100 ? '...' : '');
        
        html += '<div class="card match-card"><div class="card-body">';
        html += '<div class="d-flex justify-content-between align-items-start"><div style="flex: 1;">';
        html += '<h6 class="mb-2">Transaction: $' + m.transaction_amount.toFixed(2) + '</h6>';
        html += '<div class="mb-2">';
        html += '<span class="date-badge"><i class="bi bi-calendar-event me-1"></i>Bank: ' + transDate + '</span>';
        html += '<span class="date-badge"><i class="bi bi-receipt me-1"></i>Invoice: ' + invDate + '</span>';
        html += '</div>';
        html += '<div class="description-text">';
        html += '<small class="text-muted" style="cursor: help;">' + truncatedDescription + '</small>';
        html += '<span class="tooltip-content">' + fullDescription.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
        html += '</div>';
        html += '</div><span class="badge confidence-badge bg-' + badgeColor + '">' + m.confidence + '%</span></div><div class="divider"></div>';
        html += '<div><strong>Invoice ' + m.invoice_number + '</strong> - ' + m.company_name + '<br>';
        html += '<small class="text-muted">Amount: $' + m.invoice_amount.toFixed(2) + ' | Expected: $' + m.expected_amount.toFixed(2) + '</small></div>';
        
        // Escape transaction description for onclick attributes
        const escapedDesc = (m.transaction_description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const escapedCompany = (m.company_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        html += '<div class="mt-3 d-flex gap-2">';
        html += '<button class="btn btn-success btn-sm" onclick="approveMatch(\'' + m.invoice_id + '\', \'' + (m.transaction_date || '') + '\', \'' + escapedDesc + '\', \'' + escapedCompany + '\')"><i class="bi bi-check-circle me-1"></i>Approve</button>';
        html += '<button class="btn btn-danger btn-sm" onclick="denyMatch(\'' + m.invoice_id + '\', \'' + escapedDesc + '\')"><i class="bi bi-x-circle me-1"></i>Deny</button>';
        html += '</div>';
        html += '</div></div>';
      }
      container.innerHTML = html;
    }

    async function approveMatch(invoiceId, transactionDate, transactionDesc, companyName) {
      const response = await fetch('/approve-bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          approvals: [{
            invoice_id: invoiceId,
            transaction_date: transactionDate,
            transaction_description: transactionDesc,
            company_name: companyName
          }]
        })
      });
      const result = await response.json();
      alert(result.status === 'success' ? 'Match approved!' : 'Failed');
      runReconciliation();
    }

    async function denyMatch(invoiceId, transactionDesc) {
      if (!confirm('Deny this match? It will not be suggested again for this exact transaction.')) {
        return;
      }
      
      try {
        const response = await fetch('/deny', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            invoice_id: invoiceId,
            transaction_description: transactionDesc
          })
        });
        const result = await response.json();
        
        if (result.status === 'success') {
          alert('âœ“ Match denied and recorded. This pairing won\'t be suggested again.');
          runReconciliation();
        } else {
          alert('Failed to deny match: ' + (result.message || 'Unknown error'));
        }
      } catch(e) {
        alert('Error denying match: ' + e.message);
      }
    }

    async function loadValidationReport() {
      const container = document.getElementById('validation-list');
      const summaryDiv = document.getElementById('validation-summary');
      
      container.innerHTML = '<div class="text-muted"><span class="spinner-border spinner-border-sm me-2"></span>Validating payment history for all companies...</div>';
      
      try {
        const response = await fetch('/validation-report?days=730');
        const result = await response.json();
        
        // Update summary cards
        document.getElementById('balanced-count').innerText = result.summary.balanced;
        document.getElementById('short-count').innerText = result.summary.short;
        document.getElementById('over-count').innerText = result.summary.over;
        document.getElementById('total-companies').innerText = result.summary.total_companies;
        summaryDiv.style.display = 'block';
        
        // Display results
        let html = '';
        
        // Balanced companies
        if (result.balanced_companies.length > 0) {
          html += '<h6 class="text-success mb-3"><i class="bi bi-check-circle me-2"></i>Balanced Companies (' + result.balanced_companies.length + ')</h6>';
          for (let company of result.balanced_companies) {
            html += '<div class="card" style="border-left: 4px solid var(--success); margin-bottom: 10px;">';
            html += '<div class="card-body">';
            html += '<div class="d-flex justify-content-between align-items-start">';
            html += '<div><strong>' + company.company_name + '</strong>';
            html += '<br><small class="text-muted">' + company.message + '</small>';
            html += '<br><small class="text-muted">Paid Invoices: $' + company.paid_invoices_total.toFixed(2) + ' | Payments: $' + company.payments_total.toFixed(2) + '</small>';
            html += '</div>';
            html += '<span class="badge bg-success">âœ“ OK</span>';
            html += '</div></div></div>';
          }
        }
        
        // Companies missing payments
        if (result.short_companies.length > 0) {
          html += '<h6 class="text-warning mb-3 mt-4"><i class="bi bi-exclamation-triangle me-2"></i>Companies Missing Payments (' + result.short_companies.length + ')</h6>';
          for (let company of result.short_companies) {
            html += '<div class="card" style="border-left: 4px solid var(--warning); margin-bottom: 10px;">';
            html += '<div class="card-body">';
            html += '<div class="d-flex justify-content-between align-items-start">';
            html += '<div><strong>' + company.company_name + '</strong>';
            html += '<br><small class="text-muted">' + company.message + '</small>';
            html += '<br><small class="text-muted">Paid Invoices: $' + company.paid_invoices_total.toFixed(2) + ' | Payments Found: $' + company.payments_total.toFixed(2) + '</small>';
            html += '<br><small class="text-warning"><strong>Action needed:</strong> Review payment history manually</small>';
            html += '</div>';
            html += '<span class="badge bg-warning">âš  SHORT</span>';
            html += '</div></div></div>';
          }
        }
        
        // Companies with extra payments
        if (result.over_companies.length > 0) {
          html += '<h6 class="text-info mb-3 mt-4"><i class="bi bi-info-circle me-2"></i>Companies with Extra Payments (' + result.over_companies.length + ')</h6>';
          for (let company of result.over_companies) {
            html += '<div class="card" style="border-left: 4px solid var(--primary); margin-bottom: 10px;">';
            html += '<div class="card-body">';
            html += '<div class="d-flex justify-content-between align-items-start">';
            html += '<div><strong>' + company.company_name + '</strong>';
            html += '<br><small class="text-muted">' + company.message + '</small>';
            html += '<br><small class="text-muted">Paid Invoices: $' + company.paid_invoices_total.toFixed(2) + ' | Payments Found: $' + company.payments_total.toFixed(2) + '</small>';
            html += '<br><small class="text-info"><strong>Note:</strong> May have prepayment or payment applied to open invoice</small>';
            html += '</div>';
            html += '<span class="badge bg-info">â„¹ OVER</span>';
            html += '</div></div></div>';
          }
        }
        
        if (html === '') {
          html = '<div class="muted-box"><span class="text-muted">No companies found with transactions</span></div>';
        }
        
        container.innerHTML = html;
      } catch(e) {
        container.innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
      }
    }

    async function loadAssociations() {
      const response = await fetch('/associations');
      const result = await response.json();
      document.getElementById('associations-count').innerText = result.count;
      const container = document.getElementById('associations-list');
      if (result.count === 0) {
        container.innerHTML = '<div class="muted-box"><span class="text-muted">No associations yet...</span></div>';
        return;
      }
      let html = '';
      for(const [trans, company] of Object.entries(result.associations)) {
        html += '<div class="list-row">';
        html += '<div><strong>' + trans + '</strong> â†’ ' + company + '</div>';
        html += '<button class="btn btn-danger btn-sm" onclick="deleteAssociation(\'' + trans.replace(/'/g, '') + '\')">Delete</button>';
        html += '</div>';
      }
      container.innerHTML = html;
    }

    async function deleteAssociation(name) {
      if (confirm('Delete this association?')) {
        await fetch('/associations/' + encodeURIComponent(name), {method: 'DELETE'});
        loadAssociations();
      }
    }

    async function loadSchedule() {
      const response = await fetch('/schedule');
      const result = await response.json();
      document.getElementById('schedule-status').innerText = result.frequency || 'Not Set';
    }

    async function checkNotificationStatus() {
      try {
        const response = await fetch('/health');
        const result = await response.json();

        const emailStatus = result.services.email === 'configured' ?
          '<span class="text-success">âœ“ Configured</span>' :
          '<span class="text-warning">âš  Not configured - Add SMTP settings to .env</span>';

        const whatsappStatus = result.services.whatsapp === 'configured' ?
          '<span class="text-success">âœ“ Configured</span>' :
          '<span class="text-warning">âš  Not configured - Add Twilio credentials to .env</span>';

        document.getElementById('email-status').innerHTML = emailStatus;
        document.getElementById('whatsapp-status').innerHTML = whatsappStatus;
      } catch(e) {
        console.error('Failed to check notification status:', e);
      }
    }

    async function sendTestNotification(type) {
      const resultDiv = document.getElementById('notification-result');
      resultDiv.innerHTML = '<div class="alert alert-info">Sending test notification...</div>';
      try {
        const response = await fetch('/send-test-notification', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            via_email: type === 'email' || type === 'both',
            via_whatsapp: type === 'whatsapp' || type === 'both'
          })
        });
        const result = await response.json();

        if (result.status === 'success') {
          let message = '<div class="alert alert-success"><strong>Test Results:</strong><br>';
          if (result.results.email.sent) {
            message += 'âœ“ Email sent successfully!<br>';
          } else if (result.results.email.error) {
            message += 'âœ— Email failed: ' + result.results.email.error + '<br>';
          }
          if (result.results.whatsapp.sent) {
            message += 'âœ“ WhatsApp sent successfully!<br>';
          } else if (result.results.whatsapp.error) {
            message += 'âœ— WhatsApp failed: ' + result.results.whatsapp.error + '<br>';
          }
          message += '</div>';
          resultDiv.innerHTML = message;
        } else {
          resultDiv.innerHTML = '<div class="alert alert-danger">Test failed: ' + (result.message || 'Unknown error') + '</div>';
        }
      } catch(e) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + e.message + '</div>';
      }
    }
  </script>
</body>
</html>