<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klaus Collections Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; }
        .navbar { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { background: #fff; border-bottom: 2px solid #f0f0f0; font-weight: 600; }
        .stat-card { text-align: center; padding: 20px; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #2c3e50; }
        .stat-label { color: #7f8c8d; font-size: 0.9rem; }
        .email-preview { background: #fafafa; border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #3498db; }
        .email-preview.vip { border-left-color: #9b59b6; }
        .email-preview.approval { border-left-color: #f39c12; }
        .badge-vip { background: #9b59b6; }
        .badge-autonomous { background: #27ae60; }
        .badge-approval { background: #f39c12; }
        .btn-klaus { background: #2c3e50; color: white; }
        .btn-klaus:hover { background: #34495e; color: white; }
        .loading { display: none; }
        .escalation-1 { border-left-color: #27ae60; }
        .escalation-2 { border-left-color: #f1c40f; }
        .escalation-3 { border-left-color: #e67e22; }
        .escalation-4 { border-left-color: #e74c3c; }
        .escalation-5 { border-left-color: #c0392b; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-robot me-2"></i>Klaus Collections Agent
            </span>
            <a href="/" class="btn btn-outline-light btn-sm">
                <i class="bi bi-arrow-left me-1"></i>Back to Reconciliation
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="stat-overdue">-</div>
                    <div class="stat-label">Overdue Invoices</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="stat-amount">-</div>
                    <div class="stat-label">Total Outstanding</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="stat-autonomous">-</div>
                    <div class="stat-label">Ready to Send</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value" id="stat-approval">-</div>
                    <div class="stat-label">Need Approval</div>
                </div>
            </div>
        </div>

        <!-- Main Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-lightning-charge me-2"></i>Actions</span>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-klaus btn-lg me-2" onclick="analyzeInvoices()">
                            <i class="bi bi-search me-2"></i>Analyze Overdue Invoices
                        </button>
                        <button class="btn btn-success btn-lg me-2" onclick="sendAutonomousEmails()" id="btn-send" disabled>
                            <i class="bi bi-send me-2"></i>Send Autonomous Emails
                        </button>
                        <button class="btn btn-outline-secondary" onclick="loadHistory()">
                            <i class="bi bi-clock-history me-2"></i>View History
                        </button>
                        <div class="loading mt-3" id="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Processing...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="row">
            <!-- Autonomous Emails -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-check-circle text-success me-2"></i>Autonomous Emails
                        <span class="badge bg-success ms-2" id="count-autonomous">0</span>
                    </div>
                    <div class="card-body" id="autonomous-list" style="max-height: 500px; overflow-y: auto;">
                        <p class="text-muted">Click "Analyze" to see emails ready to send</p>
                    </div>
                </div>
            </div>

            <!-- Approval Required -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>Requires Approval
                        <span class="badge bg-warning text-dark ms-2" id="count-approval">0</span>
                    </div>
                    <div class="card-body" id="approval-list" style="max-height: 500px; overflow-y: auto;">
                        <p class="text-muted">VIP clients and high-value invoices appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History -->
        <div class="row mt-4" id="history-section" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history me-2"></i>Communication History
                    </div>
                    <div class="card-body" id="history-list" style="max-height: 400px; overflow-y: auto;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Preview Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Email Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>To:</strong> <span id="modal-to"></span>
                    </div>
                    <div class="mb-3">
                        <strong>Subject:</strong> <span id="modal-subject"></span>
                    </div>
                    <div class="mb-3">
                        <strong>CC:</strong> <span id="modal-cc"></span>
                    </div>
                    <hr>
                    <div id="modal-body" style="white-space: pre-wrap; font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="modal-send-btn" onclick="sendSingleEmail()">
                        <i class="bi bi-send me-1"></i>Send This Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let analysisResults = null;
        let currentEmailData = null;

        async function analyzeInvoices() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('btn-send').disabled = true;
            
            try {
                const response = await fetch('/klaus/analyze', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days_overdue_min: 7, include_vip: true })
                });
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to analyze');
                }
                
                // Data is wrapped in 'analysis' key
                const data = result.analysis || result;
                analysisResults = data;
                
                // Update stats
                document.getElementById('stat-overdue').textContent = data.total_analyzed || 0;
                document.getElementById('stat-autonomous').textContent = data.autonomous_emails?.length || 0;
                document.getElementById('stat-approval').textContent = data.pending_approvals?.length || 0;
                
                // Calculate total amount
                let totalAmount = 0;
                if (data.autonomous_emails) {
                    data.autonomous_emails.forEach(e => totalAmount += e.total_balance || 0);
                }
                if (data.pending_approvals) {
                    data.pending_approvals.forEach(e => totalAmount += e.total_balance || 0);
                }
                document.getElementById('stat-amount').textContent = '$' + totalAmount.toLocaleString();
                
                // Update counts
                document.getElementById('count-autonomous').textContent = data.autonomous_emails?.length || 0;
                document.getElementById('count-approval').textContent = data.pending_approvals?.length || 0;
                
                // Render autonomous emails
                renderEmailList('autonomous-list', data.autonomous_emails || [], false);
                
                // Render approval emails
                renderEmailList('approval-list', data.pending_approvals || [], true);
                
                // Enable send button if there are autonomous emails
                if (data.autonomous_emails && data.autonomous_emails.length > 0) {
                    document.getElementById('btn-send').disabled = false;
                }
                
            } catch (error) {
                alert('Error analyzing invoices: ' + error.message);
            }
            
            document.getElementById('loading').style.display = 'none';
        }

        function renderEmailList(containerId, emails, requiresApproval) {
            const container = document.getElementById(containerId);
            
            if (!emails || emails.length === 0) {
                container.innerHTML = '<p class="text-muted">No emails in this category</p>';
                return;
            }
            
            let html = '';
            emails.forEach((email, index) => {
                const escalationClass = `escalation-${email.escalation_level || 1}`;
                const vipBadge = email.is_vip ? '<span class="badge badge-vip">VIP</span>' : '';
                
                html += `
                    <div class="email-preview ${escalationClass} ${requiresApproval ? 'approval' : ''}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${email.contact_name || 'Unknown'}</strong> ${vipBadge}
                                <br><small class="text-muted">${email.contact_email || ''}</small>
                            </div>
                            <div class="text-end">
                                <strong>$${(email.total_balance || 0).toLocaleString()}</strong>
                                <br><small class="text-muted">${email.invoice_count || 0} invoice(s)</small>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small>
                                <span class="badge bg-secondary">${email.oldest_days_overdue || 0} days overdue</span>
                                <span class="badge bg-info">Level ${email.escalation_level || 1}</span>
                            </small>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Companies: ${(email.companies || []).join(', ')}</small>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="previewEmail(${index}, ${requiresApproval})">
                                <i class="bi bi-eye me-1"></i>Preview
                            </button>
                            ${requiresApproval ? `
                                <button class="btn btn-sm btn-success" onclick="approveAndSend(${index})">
                                    <i class="bi bi-check me-1"></i>Approve & Send
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function previewEmail(index, isApproval) {
            const emails = isApproval ? analysisResults.pending_approvals : analysisResults.autonomous_emails;
            const email = emails[index];
            
            currentEmailData = { ...email, index, isApproval };
            
            document.getElementById('modal-to').textContent = `${email.contact_name} <${email.contact_email}>`;
            document.getElementById('modal-cc').textContent = email.is_vip ? 'daniel@leveragelivelocal.com' : '(none)';
            
            // Get the full message
            const message = email.recommended_message || 'No message generated';
            
            // Parse subject from message - handle various newline formats
            let subject = 'Payment Reminder';
            let body = message;
            
            // Normalize newlines
            const normalizedMessage = message.replace(/\r\n/g, '\n');
            
            if (normalizedMessage.startsWith('Subject:')) {
                // Find the first blank line (double newline)
                const firstBlankLine = normalizedMessage.indexOf('\n\n');
                if (firstBlankLine > -1) {
                    subject = normalizedMessage.substring(0, firstBlankLine).replace('Subject:', '').trim();
                    body = normalizedMessage.substring(firstBlankLine + 2);
                } else {
                    subject = normalizedMessage.replace('Subject:', '').trim();
                    body = '(No body content)';
                }
            }
            
            document.getElementById('modal-subject').textContent = subject;
            document.getElementById('modal-body').textContent = body;
            
            // Debug: log to console
            console.log('Full message:', message);
            console.log('Subject:', subject);
            console.log('Body length:', body.length);
            
            // Show/hide send button based on approval status
            document.getElementById('modal-send-btn').style.display = isApproval ? 'inline-block' : 'none';
            
            new bootstrap.Modal(document.getElementById('emailModal')).show();
        }

        async function sendAutonomousEmails() {
            if (!analysisResults || !analysisResults.autonomous_emails) {
                alert('No emails to send. Run analysis first.');
                return;
            }
            
            if (!confirm(`Send ${analysisResults.autonomous_emails.length} autonomous emails now?`)) {
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            
            let sent = 0;
            let errors = [];
            
            for (const email of analysisResults.autonomous_emails) {
                try {
                    // Parse subject from message
                    const message = email.recommended_message || '';
                    const normalizedMessage = message.replace(/\r\n/g, '\n');
                    
                    let subject = 'Payment Reminder';
                    let body = normalizedMessage;
                    
                    if (normalizedMessage.startsWith('Subject:')) {
                        const firstBlankLine = normalizedMessage.indexOf('\n\n');
                        if (firstBlankLine > -1) {
                            subject = normalizedMessage.substring(0, firstBlankLine).replace('Subject:', '').trim();
                            body = normalizedMessage.substring(firstBlankLine + 2);
                        }
                    }
                    
                    // Get first invoice ID from the invoices array
                    const firstInvoice = email.invoices && email.invoices[0];
                    const invoiceId = firstInvoice ? String(firstInvoice.invoice_id || firstInvoice.id || 'unknown') : 'unknown';
                    
                    // Validate required fields
                    if (!email.contact_email || !email.contact_name) {
                        errors.push(`${email.contact_name || 'Unknown'}: Missing email or name`);
                        continue;
                    }
                    
                    const requestBody = {
                        invoice_id: invoiceId,
                        to_email: email.contact_email,
                        to_name: email.contact_name,
                        subject: subject,
                        body: body
                    };
                    
                    // Only add cc if it's a VIP
                    if (email.is_vip) {
                        requestBody.cc = 'daniel@leveragelivelocal.com';
                    }
                    
                    console.log('Sending email:', requestBody);
                    
                    const response = await fetch('/klaus/email/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (response.ok) {
                        sent++;
                    } else {
                        const err = await response.json();
                        // Handle FastAPI validation errors which come as an array
                        let errorMsg = 'Unknown error';
                        if (err.detail) {
                            if (Array.isArray(err.detail)) {
                                errorMsg = err.detail.map(e => `${e.loc?.join('.')}: ${e.msg}`).join(', ');
                            } else if (typeof err.detail === 'string') {
                                errorMsg = err.detail;
                            } else {
                                errorMsg = JSON.stringify(err.detail);
                            }
                        }
                        errors.push(`${email.contact_name}: ${errorMsg}`);
                    }
                } catch (e) {
                    errors.push(`${email.contact_name}: ${e.message}`);
                }
            }
            
            document.getElementById('loading').style.display = 'none';
            
            let message = `✅ Sent ${sent} emails successfully.`;
            if (errors.length > 0) {
                message += `\n\n❌ ${errors.length} errors:\n${errors.join('\n')}`;
            }
            
            alert(message);
            
            // Refresh analysis
            analyzeInvoices();
        }

        async function approveAndSend(index) {
            const email = analysisResults.pending_approvals[index];
            
            if (!confirm(`Send email to ${email.contact_name} (${email.contact_email})?`)) {
                return;
            }
            
            // Parse subject from message
            const message = email.recommended_message || '';
            const normalizedMessage = message.replace(/\r\n/g, '\n');
            
            let subject = 'Payment Reminder';
            let body = normalizedMessage;
            
            if (normalizedMessage.startsWith('Subject:')) {
                const firstBlankLine = normalizedMessage.indexOf('\n\n');
                if (firstBlankLine > -1) {
                    subject = normalizedMessage.substring(0, firstBlankLine).replace('Subject:', '').trim();
                    body = normalizedMessage.substring(firstBlankLine + 2);
                }
            }
            
            // Get first invoice ID from the invoices array
            const firstInvoice = email.invoices && email.invoices[0];
            const invoiceId = firstInvoice ? String(firstInvoice.invoice_id || firstInvoice.id || 'unknown') : 'unknown';
            
            const requestBody = {
                invoice_id: invoiceId,
                to_email: email.contact_email,
                to_name: email.contact_name,
                subject: subject,
                body: body
            };
            
            if (email.is_vip) {
                requestBody.cc = 'daniel@leveragelivelocal.com';
            }
            
            console.log('Sending email:', requestBody);
            
            try {
                const response = await fetch('/klaus/email/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (response.ok) {
                    alert('✅ Email sent successfully!');
                    analyzeInvoices();
                } else {
                    const err = await response.json();
                    let errorMsg = 'Unknown error';
                    if (err.detail) {
                        if (Array.isArray(err.detail)) {
                            errorMsg = err.detail.map(e => `${e.loc?.join('.')}: ${e.msg}`).join(', ');
                        } else if (typeof err.detail === 'string') {
                            errorMsg = err.detail;
                        } else {
                            errorMsg = JSON.stringify(err.detail);
                        }
                    }
                    alert('❌ Failed to send: ' + errorMsg);
                }
            } catch (e) {
                alert('❌ Error: ' + e.message);
            }
        }

        async function sendSingleEmail() {
            if (!currentEmailData) return;
            
            bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
            await approveAndSend(currentEmailData.index);
        }

        async function loadHistory() {
            document.getElementById('history-section').style.display = 'block';
            
            try {
                const response = await fetch('/klaus/history');
                const data = await response.json();
                
                const container = document.getElementById('history-list');
                
                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<p class="text-muted">No communication history yet</p>';
                    return;
                }
                
                let html = '<table class="table table-sm"><thead><tr><th>Date</th><th>Company</th><th>Method</th><th>Type</th></tr></thead><tbody>';
                
                data.history.slice(-50).reverse().forEach(h => {
                    const date = new Date(h.sent_at).toLocaleString();
                    html += `<tr>
                        <td><small>${date}</small></td>
                        <td>${h.company_name || '-'}</td>
                        <td><span class="badge bg-secondary">${h.method || '-'}</span></td>
                        <td>${h.message_type || '-'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (e) {
                document.getElementById('history-list').innerHTML = '<p class="text-danger">Error loading history</p>';
            }
        }

        // Load stats on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-analyze on load
            analyzeInvoices();
        });
    </script>
</body>
</html>